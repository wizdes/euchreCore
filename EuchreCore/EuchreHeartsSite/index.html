<!DOCTYPE html>
<html>
<head>
    <script type="text/javascript" src="http://code.createjs.com/createjs-2013.12.12.min.js"></script>
    <script type="text/javascript" src="cardUtil.js"></script>
    <script src="Scripts/jquery-1.10.2.min.js"></script>
    <!--Reference the SignalR library. -->
    <script src="Scripts/jquery.signalR-2.0.2.min.js"></script>
    <!--Reference the autogenerated SignalR hub script. -->
    <script src="signalr/hubs"></script>
    <title>Multiplayer Hearts Game</title>
    <style type="text/css">
        .container {
            background-color: #99CCFF;
            border: thick solid #808080;
            padding: 20px;
            margin: 20px;
        }

        #canvas-container {
            width: 100%;
            text-align: center;
        }

        canvas {
            display: inline;
            background-color: #006400;
        }
    </style>
    <script type="text/javascript">
        var chat;
        $(function () {
            // Declare a proxy to reference the hub.
            chat = $.connection.chatHub;
            // Create a function that the hub can call to broadcast messages.
            chat.client.broadcastMessage = function (name, message) {

                if (name == '0' || name == '1' || name == '2' || name == '3') {
                    addingCardToMiddle(parseInt(message));
                } else {
                    // Html encode display name and message.
                    var encodedName = $('<div />').text(name).html();
                    var encodedMsg = $('<div />').text(message).html();
                    // Add the message to the page.
                    $('#discussion').append('<li><strong>' + encodedName
                        + '</strong>:&nbsp;&nbsp;' + encodedMsg + '</li>');
                }
            };
            // Get the user name and store it to prepend to messages.
            $('#displayname').val(prompt('Enter your name:', ''));
            // Set initial focus to message input box.
            $('#message').focus();
            // Start the connection.
            $.connection.hub.start().done(function () {
                $('#sendmessage').click(function () {
                    // Call the Send method on the hub.
                    chat.server.send($('#displayname').val(), $('#message').val());
                    // Clear text box and reset focus for next comment.
                    $('#message').val('').focus();
                });
            });
        });

        var img;
        var stage;
        var imgArray;

        var cardsInMiddle;
        var discardedCards;
        var players;
        var bmpMap;
        var reverseBmpMap;

        function Player() {
            this.cardArray = [];
            this.playerNum = 0;
            this.cardsInMiddle = [];
            this.discardedCards = [];
            this.setPlayerNum = function (i) {
                this.playerNum = i;
            };

            this.addCardToPlayer = function (card) {
                this.cardArray[this.cardArray.length] = card;
            }
        }

        function init() {
            if (window.top != window) {
                document.getElementById("header").style.display = "none";
            }

            var canvas = document.getElementById("testCanvas");
            stage = new createjs.Stage(canvas);

            players = [];
            imgArray = [];
            bmpMap = [];
            reverseBmpMap = [];

            players[0] = new Player();
            players[1] = new Player();
            players[2] = new Player();
            players[3] = new Player();

            players[0].setPlayerNum(0);
            players[1].setPlayerNum(1);
            players[2].setPlayerNum(2);
            players[3].setPlayerNum(3);

            createjs.Touch.enable(stage);
            stage.enableMouseOver(10);

            for (i = 0; i < 52; i++) {
                imgLoader = new Image();
                fileStringName = "http://chatapp2.azurewebsites.net/resources/";
                fileStringName = "resources/";
                fileStringName = fileStringName + GetCardName(i) + ".png";
                imgLoader.src = fileStringName;
                imgArray[i] = imgLoader;
            }

            for (i = 0; i < 4; i++) {
                for (j = 0; j < 13; j++) {
                    players[i].addCardToPlayer(i * 13 + j);
                }
            }

            for (i = 0; i < 4; i++) {
                player = players[i];

                for (j = 0; j < 13; j++) {
                    bmp = new createjs.Bitmap(imgArray[player.cardArray[j]]);
                    var position = new Pair();
                    position.init(player.cardArray[j]);
                    bmp.x = position.x;
                    bmp.y = position.y;
                    bmp.scaleX = bmp.scaleY = 0.18;

                    bmp.on("mousedown", onCardClick);
                    reverseBmpMap[player.cardArray[j]] = bmp;
                    stage.addChild(bmp);
                }
            }

            // Create a new Text object and a rectangle Shape object, and position them inside a container:
            var container = new createjs.Container();
            container.x = 200;
            container.y = 200;

            var target = new createjs.Shape();
            target.graphics.beginFill("#000").drawRect(-10, -10, 200, 40).beginFill("#FFF");
            container.addChild(target);

            var txt = new createjs.Text("Click to clear 4 cards", "20px Arial", "#FFF");
            txt.textBaseline = "top";
            container.addChild(txt);

            stage.addChild(container);

            container.addEventListener("dblclick", function (evt) { clearMiddleCards(); });

            update = true;
            stage.update();
            createjs.Ticker.addEventListener("tick", tick);
        }

        function tick(event) {
            if (update) {
                update = true; // only update once
                stage.update(event);
            }
        }

        function clearMiddleCards() {
            for (i = 0; i < 4; i++) {
                if (players[i].cardsInMiddle.length == 0) {
                    return;
                }
            }
            for (i = 0; i < 4; i++) {
                for (index = 0; index < players[i].cardsInMiddle.length; index++) {
                    var value = players[i].cardsInMiddle[index];
                    players[i].discardedCards[players[i].discardedCards.length] = value;
                    reverseBmpMap[value].visible = false;
                    update = true;
                }
                players[i].cardsInMiddle = [];
            }
        }

        function onCardClick(evt) {
            this.parent.addChild(this);
            var cardNum = reverseBmpMap.indexOf(this);
            addingCardToMiddle(cardNum);
        }

        function addingCardToMiddle(cardNum) {
            for (i = 0; i < 4; i++) {
                if (players[i].cardArray.indexOf(cardNum) == -1) {
                    continue;
                }

                if (players[i].cardsInMiddle.indexOf(cardNum) != -1) {
                    continue;
                }

                players[i].cardsInMiddle.push(cardNum);
                reverseBmpMap[cardNum].x = 450 + i * 100;
                reverseBmpMap[cardNum].y = 300;
                update = true;

                chat.server.send(i.toString(), cardNum.toString());
            }
        }
    </script>
</head>
<body onload="init()">
    <div class="container">
        <input type="text" id="message" />
        <input type="button" id="sendmessage" value="Send" />
        <input type="hidden" id="displayname" />
        <ul id="discussion"></ul>
    </div>
    <header id=" header" class="EaselJS">
        <h1>Hearts Card Game</h1>
        <p>The hearts card game build using Easel and Websockets.</p>
    </header>

    <div id="canvas-container">
        <canvas id="testCanvas" width="1280" height="768">Your browser doesn't support easel.js.</canvas>
    </div>

</body>
</html>